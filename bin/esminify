#!/usr/bin/env node
'use strict';

const esminify = require('../index');
const cmd = require('commander');

function parseExclude(str) {
  var rules = [];
  if (!str) {
    return rules;
  }
  str.split(',').forEach(function (rule) {
    rule = rule.trim();
    if (!rule) {
      return;
    }
    rules.push(genRule(rule));
  });
  return rules;
}

/*
function parseCmd(str) {
  var result = {};
  if (!str) {
    return undefined;
  }
  if (str === 'true') {
    return result;
  }
  result.globals = str.split(',');
  return result;
}
*/

function genRule(rule) {
  if (rule.indexOf('/') === 0) {
    rule = '^' + rule;
  }
  return new RegExp(rule.replace(/\./g, '\\.').replace(/\*/g, '.*'));
}

function absPath(p) {
  var flag = false;
  if (process.platform.indexOf('win') === 0) {
    if (/^\w:/.test(p)) {
      flag = true;
    }
  } else {
    if (/^\//.test(p)) {
      flag = true;
    }
  }
  return flag;
}

cmd
  .usage('[options] $your_code_dir')
  .description('minify you js code')
  .option('-x, --exclude [value]', 'exclude dirs')
  .option('--force-override-exclude', 'force override the default exclude rules')
  .option('-o, --output [value]', 'set the output dir')
  .option('-c, --config [value]', 'config the minify format')
  .option('--no-strict', 'compress without strict mod')
  .option('--cmd', 'compress as cmd module')
  .parse(process.argv);


var args = cmd;
var input = cmd.args[0];
var output = args.output;
var cwd = process.cwd();
var path = require('path');
var exclude = parseExclude(args.exclude);

if (!input) {
  cmd.help();
  process.exit(0);
}

if (!absPath(input)) {
  input = path.join(cwd, input);
  output = output ? path.join(cwd, output) : null;
}
esminify.minify({
  input: input,
  output: output,
  exclude: exclude,
  forceOverrideExclude: args.forceOverrideExclude,
  strictMod: !args.noStrict,
  cmd: args.cmd,
  onFileProcess: function (obj) {
    console.log('minify file:', obj.input.substr(cwd.length + 1), '>', obj.output.substr(cwd.length + 1));
  }
});
